name: WTW Reindex Qdrant (Production)

on:
  workflow_dispatch:
    inputs:
      collection_name:
        description: "Qdrant collection name"
        required: true
        default: "wearables"
      qdrant_host:
        description: "Qdrant host reachable from Docker network"
        required: true
        default: "wtw-qdrant"
      qdrant_port:
        description: "Qdrant HTTP port"
        required: true
        default: "6333"
      dataset_dir:
        description: "Optional override: absolute server path containing dataset.csv and images/"
        required: false
        default: "__unset__"
      recreate:
        description: "Recreate collection before indexing (true/false)"
        required: true
        default: "false"

permissions:
  contents: read
  packages: write

concurrency:
  group: reindex-qdrant-prod
  cancel-in-progress: false

jobs:
  reindex:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Normalize image owner
        run: echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> "$GITHUB_ENV"

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push embedding image
        uses: docker/build-push-action@v6
        with:
          context: ./python/embedding
          file: ./docker/embedding/Dockerfile
          push: true
          cache-from: type=gha,scope=wtw-embedding
          cache-to: type=gha,mode=max,scope=wtw-embedding
          tags: |
            ghcr.io/${{ env.OWNER_LC }}/wtw-embedding:${{ github.sha }}
            ghcr.io/${{ env.OWNER_LC }}/wtw-embedding:latest

      - name: Resolve dataset dir
        env:
          DATASET_DIR_INPUT: ${{ github.event.inputs.dataset_dir }}
          DATASET_DIR_SECRET: ${{ secrets.PROD_EMBEDDING_DATASET_DIR }}
        run: |
          DIR="$DATASET_DIR_INPUT"
          if [ "$DIR" = "__unset__" ] || [ -z "$DIR" ]; then
            DIR="$DATASET_DIR_SECRET"
          fi
          if [ -z "$DIR" ]; then
            echo "::error::Dataset path is required. Set workflow input 'dataset_dir' or secret 'PROD_EMBEDDING_DATASET_DIR'."
            exit 1
          fi
          echo "DATASET_DIR_RESOLVED=$DIR" >> "$GITHUB_ENV"

      - name: Run reindex on server
        uses: appleboy/ssh-action@v1.0.3
        env:
          EMBEDDING_IMAGE: ghcr.io/${{ env.OWNER_LC }}/wtw-embedding:${{ github.sha }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
          REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
          COLLECTION_NAME: ${{ github.event.inputs.collection_name }}
          QDRANT_HOST: ${{ github.event.inputs.qdrant_host }}
          QDRANT_PORT: ${{ github.event.inputs.qdrant_port }}
          DATASET_DIR_RESOLVED: ${{ env.DATASET_DIR_RESOLVED }}
          RECREATE: ${{ github.event.inputs.recreate }}
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          envs: EMBEDDING_IMAGE,DEPLOY_PATH,REGISTRY_USERNAME,REGISTRY_PASSWORD,COLLECTION_NAME,QDRANT_HOST,QDRANT_PORT,DATASET_DIR_RESOLVED,RECREATE
          script: |
            set -euo pipefail
            cd "$DEPLOY_PATH"

            echo "Using dataset dir: $DATASET_DIR_RESOLVED"
            echo "Using collection: $COLLECTION_NAME"
            echo "Using Qdrant: $QDRANT_HOST:$QDRANT_PORT"

            if [ ! -f "$DATASET_DIR_RESOLVED/dataset.csv" ]; then
              echo "Missing $DATASET_DIR_RESOLVED/dataset.csv"
              exit 1
            fi
            if [ ! -d "$DATASET_DIR_RESOLVED/images" ]; then
              echo "Missing $DATASET_DIR_RESOLVED/images"
              exit 1
            fi

            docker login ghcr.io -u "$REGISTRY_USERNAME" -p "$REGISTRY_PASSWORD"
            docker pull "$EMBEDDING_IMAGE"

            RECREATE_FLAG=""
            if [ "$RECREATE" = "true" ]; then
              RECREATE_FLAG="--recreate"
            fi

            docker run --rm \
              --network wtw_internal \
              -v "$DATASET_DIR_RESOLVED:/data/input:ro" \
              "$EMBEDDING_IMAGE" \
              python /app/scripts/qdrant_indexer.py \
                --csv-path /data/input/dataset.csv \
                --images-path /data/input/images \
                --collection-name "$COLLECTION_NAME" \
                --qdrant-host "$QDRANT_HOST" \
                --qdrant-port "$QDRANT_PORT" \
                $RECREATE_FLAG

            # Strict post-run verification: collection must exist and contain points.
            COLLECTION_URL="http://$QDRANT_HOST:$QDRANT_PORT/collections/$COLLECTION_NAME"
            COLLECTION_JSON="$(docker exec -i python-service wget -qO- "$COLLECTION_URL")"
            echo "Collection response: $COLLECTION_JSON"

            POINTS_COUNT="$(echo "$COLLECTION_JSON" | grep -o '"points_count":[0-9]*' | head -n1 | cut -d: -f2)"
            if [ -z "$POINTS_COUNT" ]; then
              echo "Unable to parse points_count from Qdrant response."
              exit 1
            fi
            if [ "$POINTS_COUNT" -le 0 ]; then
              echo "Indexing verification failed: points_count=$POINTS_COUNT"
              exit 1
            fi
            echo "Indexing verification passed: points_count=$POINTS_COUNT"

      - name: Summary
        env:
          DATASET_DIR_INPUT: ${{ github.event.inputs.dataset_dir }}
          DATASET_DIR_RESOLVED: ${{ env.DATASET_DIR_RESOLVED }}
        run: |
          DATASET_SOURCE="input"
          if [ "$DATASET_DIR_INPUT" = "__unset__" ] || [ -z "$DATASET_DIR_INPUT" ]; then
            DATASET_SOURCE="secret(PROD_EMBEDDING_DATASET_DIR)"
          fi

          {
            echo "## Reindex Summary"
            echo ""
            echo "- Embedding image: ghcr.io/${{ env.OWNER_LC }}/wtw-embedding:${{ github.sha }}"
            echo "- Collection: ${{ github.event.inputs.collection_name }}"
            echo "- Qdrant: ${{ github.event.inputs.qdrant_host }}:${{ github.event.inputs.qdrant_port }}"
            echo "- Dataset dir: ${DATASET_DIR_RESOLVED}"
            echo "- Dataset source: ${DATASET_SOURCE}"
            echo "- Recreate: ${{ github.event.inputs.recreate }}"
            echo "- Verification: strict (fails if points_count <= 0)"
          } >> "$GITHUB_STEP_SUMMARY"
