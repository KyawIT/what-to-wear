name: what-to-wear
services:
  wtw-db:
    image: postgres:18-alpine
    container_name: wtw-db
    restart: always
    networks:
      - wtw_internal
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASS}
      POSTGRES_DB: ${DB_NAME}
    volumes:
      - wtw_data:/var/lib/postgresql/data

  wtw-keycloak:
    image: quay.io/keycloak/keycloak:26.4.5
    container_name: wtw-keycloak
    restart: always
    depends_on:
      - wtw-db
    environment:
      KC_BOOTSTRAP_ADMIN_USERNAME: ${KC_ADMIN_USER}
      KC_BOOTSTRAP_ADMIN_PASSWORD: ${KC_ADMIN_PASS}
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://wtw-db:5432/${DB_NAME}
      KC_DB_USERNAME: ${DB_USER}
      KC_DB_PASSWORD: ${DB_PASS}
      KC_DB_SCHEMA: keycloak
      KC_HOSTNAME: https://what-to-wear.cms-building.at/auth
      KC_HOSTNAME_ADMIN: https://what-to-wear.cms-building.at/auth
      KC_HOSTNAME_STRICT: "true"
      KC_PROXY_HEADERS: xforwarded
      KC_HTTP_ENABLED: "true"
      KC_HTTP_RELATIVE_PATH: /auth
    networks:
      - wtw_internal
      - proxy_default
    volumes:
      - ./keycloak-theme:/opt/keycloak/themes
      - ./wtw-realm.json:/opt/keycloak/data/import/wtw-realm.json:ro
    command:
      - start
      - --http-relative-path=/auth
      - --import-realm
    labels:
      - traefik.enable=true
      - traefik.http.routers.wtw-keycloak.rule=Host(`what-to-wear.cms-building.at`) && PathPrefix(`/auth`)
      - traefik.http.routers.wtw-keycloak.entrypoints=websecure
      - traefik.http.routers.wtw-keycloak.tls=true
      - traefik.http.routers.wtw-keycloak.tls.certresolver=default
      - traefik.http.services.wtw-keycloak.loadbalancer.server.port=8080

  wtw-minio:
    image: quay.io/minio/minio
    container_name: wtw-minio
    restart: unless-stopped
    networks:
      - wtw_internal
      - proxy_default
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY}
      MINIO_REGION: ${MINIO_REGION}
      MINIO_BROWSER: "on"
    volumes:
      - wtw_minio_data:/data
      - wtw_minio_config:/root/.minio
    command: server /data --console-address ":9001"
    labels:
      - traefik.enable=true
      - traefik.http.routers.wtw-minio.rule=Host(`what-to-wear.cms-building.at`) && PathPrefix(`/minio`)
      - traefik.http.routers.wtw-minio.entrypoints=websecure
      - traefik.http.routers.wtw-minio.tls=true
      - traefik.http.routers.wtw-minio.tls.certresolver=default
      - traefik.http.routers.wtw-minio.middlewares=wtw-minio-stripprefix
      - traefik.http.middlewares.wtw-minio-stripprefix.stripprefix.prefixes=/minio
      - traefik.http.services.wtw-minio.loadbalancer.server.port=9000

  wtw-rembg:
    image: ${REMBG_IMAGE}
    container_name: wtw-rembg
    restart: unless-stopped
    networks:
      - wtw_internal
      - proxy_default
    environment:
      REMBG_MODEL: ${REMBG_MODEL}
    labels:
      - traefik.enable=true
      - traefik.http.routers.wtw-rembg.rule=Host(`what-to-wear.cms-building.at`) && PathPrefix(`/rembg`)
      - traefik.http.routers.wtw-rembg.entrypoints=websecure
      - traefik.http.routers.wtw-rembg.tls=true
      - traefik.http.routers.wtw-rembg.tls.certresolver=default
      - traefik.http.routers.wtw-rembg.middlewares=wtw-rembg-stripprefix
      - traefik.http.middlewares.wtw-rembg-stripprefix.stripprefix.prefixes=/rembg
      - traefik.http.services.wtw-rembg.loadbalancer.server.port=8080

  wtw-qdrant:
    image: qdrant/qdrant:latest
    container_name: wtw-qdrant
    restart: unless-stopped
    networks:
      - wtw_internal
    volumes:
      - wtw_qdrant:/qdrant/storage

  wtw-embeddings:
    profiles:
      - indexing
    image: ${EMBEDDING_IMAGE}
    container_name: wtw-embeddings
    restart: "no"
    depends_on:
      - wtw-qdrant
    networks:
      - wtw_internal
    environment:
      QDRANT_HOST: wtw-qdrant
      QDRANT_PORT: "6333"
      QDRANT_COLLECTION: wearables
      MODEL_NAME: clip-ViT-B-32
      APP_ENV: production
    working_dir: /app
    command:
      - /bin/bash
      - -c
      - |
        echo "Starting Qdrant indexing..."
        python scripts/qdrant_indexer.py --csv-path ./preprocessed_dataset/dataset.csv --images-path ./preprocessed_dataset/images --collection-name wearables --qdrant-host wtw-qdrant --qdrant-port 6333 --batch-size 32
        echo "Indexing completed successfully."

  python-service:
    image: ${PYTHON_IMAGE}
    container_name: python-service
    restart: unless-stopped
    depends_on:
      - wtw-qdrant
    networks:
      - wtw_internal
    environment:
      QDRANT_HOST: wtw-qdrant
      QDRANT_PORT: "6333"
      QDRANT_COLLECTION: ${QDRANT_COLLECTION:-wearables}
      MODEL_NAME: ${PYTHON_MODEL_NAME:-clip-ViT-B-32}
      APP_ENV: production
      LOG_LEVEL: ${PYTHON_LOG_LEVEL:-INFO}
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      start_period: 120s
      retries: 5

  wtw-frontend-auth:
    image: ${FRONTEND_IMAGE}
    container_name: wtw-frontend-auth
    restart: unless-stopped
    depends_on:
      - wtw-db
      - wtw-keycloak
    networks:
      - wtw_internal
      - proxy_default
    environment:
      DATABASE_URL: postgres://${DB_USER}:${DB_PASS}@wtw-db:5432/${DB_NAME}?options=-c%20search_path%3Dauth
      BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET}
      BETTER_AUTH_URL: ${BETTER_AUTH_URL}
      EXPO_PUBLIC_BETTER_AUTH_URL: ${BETTER_AUTH_URL}
      EXPO_PUBLIC_KC_CLIENT_ID: ${FRONTEND_KC_CLIENT_ID}
      EXPO_PUBLIC_KC_SECRET: ${FRONTEND_KC_SECRET}
      EXPO_PUBLIC_KC_DISCOVERY_URL: ${FRONTEND_KC_DISCOVERY_URL}
      EXPO_PUBLIC_KC_ISSUER: ${FRONTEND_KC_ISSUER}
      EXPO_PUBLIC_KC_LOGOUT_URL: ${FRONTEND_KC_LOGOUT_URL}
      EXPO_PUBLIC_KC_POST_LOGOUT_REDIRECT_URL: frontend://logout-complete
      KC_INTERNAL_URL: http://wtw-keycloak:8080/auth/realms/wtw/
    labels:
      - traefik.enable=true
      - traefik.http.routers.wtw-frontend-auth.rule=Host(`what-to-wear.cms-building.at`) && PathPrefix(`/api/auth`)
      - traefik.http.routers.wtw-frontend-auth.entrypoints=websecure
      - traefik.http.routers.wtw-frontend-auth.tls=true
      - traefik.http.routers.wtw-frontend-auth.tls.certresolver=default
      - traefik.http.routers.wtw-frontend-auth.priority=100
      - traefik.http.services.wtw-frontend-auth.loadbalancer.server.port=8081

  wtw-backend:
    image: ${BACKEND_IMAGE}
    container_name: wtw-backend
    restart: unless-stopped
    depends_on:
      - wtw-db
      - wtw-minio
      - python-service
    networks:
      - wtw_internal
      - proxy_default
    environment:
      QUARKUS_PROFILE: prod
      QUARKUS_DATASOURCE_JDBC_URL: jdbc:postgresql://wtw-db:5432/${DB_NAME}
      QUARKUS_DATASOURCE_USERNAME: ${DB_USER}
      QUARKUS_DATASOURCE_PASSWORD: ${DB_PASS}
      QUARKUS_MINIO_URL: http://wtw-minio:9000
      QUARKUS_MINIO_REGION: ${MINIO_REGION}
      QUARKUS_MINIO_HOST: wtw-minio
      QUARKUS_MINIO_PORT: 9000
      QUARKUS_MINIO_SECURE: "false"
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      APP_MINIO_PUBLIC_BASE_URL: ${APP_MINIO_PUBLIC_BASE_URL:-https://what-to-wear.cms-building.at/minio}
      APP_PYTHON_PREDICT_URL: http://python-service:8000/wearables/predict
      APP_PYTHON_BASE_URL: http://python-service:8000
    labels:
      - traefik.enable=true
      - traefik.http.routers.wtw-backend.rule=Host(`what-to-wear.cms-building.at`) && PathPrefix(`/api`)
      - traefik.http.routers.wtw-backend.entrypoints=websecure
      - traefik.http.routers.wtw-backend.tls=true
      - traefik.http.routers.wtw-backend.tls.certresolver=default
      - traefik.http.routers.wtw-backend.priority=10
      - traefik.http.services.wtw-backend.loadbalancer.server.port=8080

volumes:
  wtw_data:
  wtw_minio_data:
  wtw_minio_config:
  wtw_qdrant:

networks:
  proxy_default:
    external: true
  wtw_internal:
    name: wtw_internal
